<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>暦情報パーツ</title>
    <style>
        /* 見た目を整えるための基本的なスタイル */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            line-height: 1.7;
            background-color: #f9f9f9;
            color: #333;
            padding: 20px;
        }
        #koyomi-widget {
            background-color: #fff;
            padding: 1.5em;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            max-width: 400px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        #koyomi-widget .loading,
        #koyomi-widget .error {
            color: #888;
            text-align: center;
        }
        #koyomi-widget strong {
            display: block;
            margin-top: 1em;
            border-top: 1px solid #eee;
            padding-top: 1em;
            font-size: 0.9em;
        }
        #koyomi-widget table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5em;
            font-size: 0.95em;
        }
        #koyomi-widget td {
            padding: 5px 0;
            vertical-align: top;
        }
        #koyomi-widget .city-name {
            /* 都市名（例：「札幌　」）の幅を固定し、レイアウトを揃える */
            width: 5em;
            white-space: pre; /* 半角スペースを維持 */
        }
        #koyomi-widget .times {
            font-family: monospace;
        }
    </style>
</head>
<body>

    <h2>ブログパーツの表示例</h2>

    <!-- このdiv要素内に暦情報が描画される -->
    <div id="koyomi-widget">
        <p class="loading">読み込み中...</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const widget = document.getElementById('koyomi-widget');
            
            // サーバーレス関数のURL。デプロイ先に応じて変更してください。
            // 例: Vercelにデプロイした場合 -> '/api/koyomi'
            const apiUrl = '/api/koyomi'; 

            // エラー表示用の関数
            const displayError = () => {
                widget.innerHTML = `<p class="error">情報の取得に失敗しました。</p>`;
            };

            // 受け取ったデータからHTMLを生成して表示する関数
            const renderData = (data) => {
                // 三点リーダーの代わりに strong タグとテーブルを使用
                let html = `
                    <p>
                        ${data.date}<br>
                        二十四節気 ${data.sekki}<br>
                        七十二候 ${data.kou}<br>
                        20時の月齢 ${data.moon_age}
                    </p>
                    <strong>日出・日入 (月出・月入)</strong>
                    <table>
                        <tbody>
                `;

                // 各都市のデータをテーブルの行として追加
                data.cities.forEach(city => {
                    html += `
                        <tr>
                            <td class="city-name">${city.name}　</td>
                            <td class="times">${city.sunrise} ${city.sunset} (${city.moonrise} ${city.moonset})</td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                `;

                widget.innerHTML = html;
            };

            // APIからデータを非同期で取得するメインの関数
            const fetchData = async () => {
                try {
                    const response = await fetch(apiUrl);
                    if (!response.ok) {
                        // HTTPステータスが 200-299 でない場合はエラー
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    renderData(data);
                } catch (error) {
                    console.error("暦データの取得に失敗しました:", error);
                    displayError();
                }
            };

            // 実行
            fetchData();
        });
    </script>

</body>
</html>
